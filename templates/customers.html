{% extends 'base.html' %}

{% block header %}Customer Management{% endblock %}

{% block content %}
<div class="card">
    <h3>Add New Customer</h3>
    <form method="POST" action="{{ url_for('main.customers') }}">
        <div class="form-row">
            <div class="form-group">
                <label>Name</label>
                <input type="text" name="name" required placeholder="Customer Name">
            </div>
            <div class="form-group">
                <label>GSTIN</label>
                <input type="text" name="gstin" placeholder="GST Number">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Address</label>
                <input type="text" name="address" placeholder="Address">
            </div>
            <div class="form-group">
                <label>State</label>
                <input type="text" name="state" placeholder="State">
            </div>
        </div>
        <button type="submit" class="btn btn-primary mt-2">Add Customer</button>
    </form>
</div>

<div class="card mt-4">
    <h3>Existing Customers</h3>
    <div class="table-responsive">
        <table class="items-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>GSTIN</th>
                    <th>Address</th>
                    <th>State</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for customer in customers %}
                <tr>
                    <td>{{ customer.name }}</td>
                    <td>{{ customer.gstin }}</td>
                    <td>{{ customer.address }}</td>
                    <td>{{ customer.state }}</td>
                    <td>
                        <div class="actions">
                            <button onclick='openEditModal({{ customer.to_dict() | tojson }}, {{ customer.id }})'
                                class="btn-sm btn-secondary">Edit</button>
                            <form action="{{ url_for('main.delete_customer', id=customer.id) }}" method="POST"
                                style="display:inline;"
                                onsubmit="return confirm('Are you sure you want to delete this customer?');">
                                <button type="submit" class="btn-sm btn-danger">Delete</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" style="text-align:center;">No customers found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
</div>

<!-- Edit Customer Modal -->
<div id="editCustomerModal" class="modal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1001; align-items:center; justify-content:center;">
    <div class="modal-content card" style="width:90%; max-width:500px; position:relative;">
        <h3 style="margin-top:0;">Edit Customer</h3>
        <span onclick="closeEditModal()"
            style="position:absolute; top:15px; right:20px; cursor:pointer; font-size:1.5rem;">&times;</span>
        <form id="editCustomerForm" method="POST">
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="editName" name="name" required>
            </div>
            <div class="form-group">
                <label>GSTIN</label>
                <input type="text" id="editGstin" name="gstin">
            </div>
            <div class="form-group">
                <label>Address</label>
                <input type="text" id="editAddress" name="address">
            </div>
            <div class="form-group">
                <label>State</label>
                <input type="text" id="editState" name="state">
            </div>
            <div class="form-actions" style="margin-top:20px;">
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openEditModal(customer, id) {
        const modal = document.getElementById('editCustomerModal');
        modal.style.display = 'flex';
        document.getElementById('editCustomerForm').action = `/customers/edit/${id}`;

        document.getElementById('editName').value = customer.name;
        document.getElementById('editGstin').value = customer.gstin || '';
        document.getElementById('editAddress').value = customer.address || '';
        document.getElementById('editState').value = customer.state || '';
    }

    function closeEditModal() {
        document.getElementById('editCustomerModal').style.display = 'none';
    }

    // Close if clicked outside
    window.onclick = function (event) {
        const modal = document.getElementById('editCustomerModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
</script>
{% endblock %}